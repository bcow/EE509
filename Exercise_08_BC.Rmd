---
title: "Exercise_08_BC"
author: "Betsy Cowdery"
date: "October 27, 2014"
output: html_document
---

## Case Study: Lab 4 pine cones data

```{r}
load("data/Lab8_cone.RData")
```

###  AIC vs Likelihood Ratio Test

```{r}
AIC.combined = 2*lnL[1] + 2*3
AIC.treatment  = 2*(lnL[2]+lnL[3]) + 2*6
AIC.combined
AIC.treatment
```

#### Compare the AICs for the two models, interpret the results for this test, and compare with the results from the LRT previously performed.

### Bootstrapped Interval Estimates
```{r}
## bootstrap
nboot <- 100    		## number of bootstrap samples
npred <- 31				## number of X values you predict for
dseq  <- seq(0,30,length=npred)		## diameter sequence
mle   <- matrix(NA,nrow=nboot,ncol=3)	## storage for parameter estimates
conf.mat  <- matrix(NA,nrow=nboot,ncol=npred)	## storage for maturation
conf.cone <- matrix(NA,nrow=nboot,ncol=npred)	## storage for fecundity
pred.mat   <- matrix(NA,nrow=nboot,ncol=npred)	## storage for predictive maturation
pred.cone <- matrix(NA,nrow=nboot,ncol=npred)	## storage for predictive fecundity
```

```{r,echo=FALSE}
likfit = function(param,dia,ncone){
  a0 = param[1]
  b0 = param[2]
  b1 = param[3]
  cones = ncone > 0

  ## trees with cones
  dia.cone  = dia[cones > 0]                ##find just the trees with cones
  g.cone = a0 * dia.cone^2			## Fecundity fnc - g(x)
  theta.cone    = pnorm(dia.cone,b0,b1,log.p=TRUE) 	## maturation probit
  prob.cone = theta.cone + dpois(ncone[cones],g.cone,log=TRUE)
  
  ##trees with zero counts 
  dia.zero  = dia[cones == 0]
  g.zero = a0 * dia.zero^2
  theta.zero    = pnorm(dia.zero,b0,b1)   	##maturation probit
  prob.zero = log((1-theta.zero) + theta.zero*dpois(0,g.zero))

  return(-sum(prob.cone,prob.zero))
}
```

 
```{r}
treatment <- c("AMB","CO2")

for(n in 1:2){
  dia.t   <- b$diam[tmt==treatment[n]]   ## tree diameters
  cones.t <- (b$c00 > 0)         ## whether cones are present
  cones.t <- cones[tmt==treatment[n]]
  ncone.t <- b$c00[tmt==treatment[n]]    ## number of cones
  
  for(i in 1:nboot){
    if(i%%100 == 0) print(i)  					## progress indicator
    samp <- sample(length(dia.t),replace=T)		##Sample row indices 
    out.boot <- optim(param,likfit,method="L-BFGS-B",	## fit model to sample
                      lower=c(0.001,10,1),upper=c(1,30,30),dia=dia.t[samp],ncone=ncone.t[samp])
    mle[i,] <- out.boot$par					## store parameters
    conf.mat[i,]  <- pnorm(dseq,mle[i,2],mle[i,3])		## store model | parms
    conf.cone[i,] <- conf.mat[i,]*mle[i,1]*dseq^2
    pred.mat[i,]  <- rbinom(npred,1,conf.mat[i,])		## store pseudodata
    pred.cone[i,] <- rpois(npred,conf.cone[i,]*pred.mat[i,])
    }
  
  ints <- list(cm=conf.mat,cc=conf.cone,pm=pred.mat,pc=pred.cone) 
  assign(paste0("ints.",treatment[n]),ints)
  
  colnames(mle) = c("a0","b0","b1")
  a0.ci <- quantile(mle[,1],c(0.025,0.975))
  b0.ci <- quantile(mle[,2],c(0.025,0.975))
  b1.ci <- quantile(mle[,3],c(0.025,0.975))
  ci <- rbind(a0.ci,b0.ci,b1.ci)
  vars <- rbind(a0,b0,b1)
  # pairs(mle)
  
  ## density plots
  par(mfrow = c(1,3))
  for(j in 1:3){
    plot(density(mle[,j]),type='l',main = colnames(mle)[j])
    abline(v=ci[j,],lty=2, col = 2)
    abline(v=vars[j,n+1], col = 4)
    
    }
  
  out <- rbind(
    c(vars[1,n+1], )
    )
    
  
  }

```

### Model Intervals

```{r}

ci.mat  <- apply(conf.mat,2,quantile,c(0.025,0.5,0.975))
ci.cone <- apply(conf.cone,2,quantile,c(0.025,0.5,0.975))
pi.mat  <- apply(pred.mat,2,quantile,c(0.025,0.975))
pi.cone <- apply(pred.cone,2,quantile,c(0.025,0.975)) 

## fecundity plot
plot(b$diam,b$c00,col = b$tmt,ylim=c(0,30))
lines(dseq,ci.cone[2,],col=2,lwd=3)   ## median model
lines(dseq,ci.cone[1,],col=2,lty=2,lwd=3)  ## 95% CI
lines(dseq,ci.cone[3,],col=2,lty=2,lwd=3)
lines(dseq,pi.cone[1,],col=3,lty=2,lwd=3)	## 95% PI
lines(dseq,pi.cone[2,],col=3,lty=2,lwd=3)
```

#### Lab Report Task 3 Plot the confidence and predictive interval for the maturation process model. Include both this plot and the fecundity plot in your lab report.



#### Lab Report Task 4 Repeat the bootstrap analysis for the elevated CO2 treatment. Include the figures and tables from tasks 2 & 3 for the elevated plots as well as a final plot that compares the model confidence intervals between the elevated and ambient data on one figure