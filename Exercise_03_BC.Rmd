---
title: "Exercise_03_BC"
author: "Betsy Cowdery"
date: "September 22, 2014"
output: html_document
---

# Case study 1: Survival Analysis

#### 1) Include code to make a plot of the exponential PDF (with the MLE parameter estimate) on top of the histogram of the data.

```{r}
## vector of survival times (days)
dat <- c(1,9,9,5,27,9,29,1,11,3,3,11,13,6,11,2,4,1,37,10)
p = 1/mean(dat)
x <- 1:40
## some basic exploratory analysis
hist(dat,freq=FALSE)
lines(p*exp(-p*x), col = 2)
```

## Case Study 2: Change in Fire Risk With Time

Fire return interval are frequently analyzed using a Weibull distribution:

$$f(x \vert c, \lambda) = \left({{c}\over{\lambda}}\right)\left( {x \over \lambda} \right)^{c-1} exp\left( -\left( {x\over \lambda} \right)^c \right)$$

```{r}
age = 0:160
size <- seq(.5,3,.5)
plot(age,dweibull(age,.1,50),type='l',ylab="density",ylim=c(0,0.025)) 
for(i in 1:length(size)){
lines(age,dweibull(age,size[i],50),col=i+1) 
}
legend("topright", inset = .05, title = "Shape", legend = c(.1,size), lty = 1, col=1:(length(size)+1))

```

#### 2) Does increasing the “shape” parameter cause fire risk to increase or decrease with age?

From the plot above, it appears that increasing "size" increases the probability of fire with age. 

#### 3) Extra Credit: Plot the CDF of these 3 distributions. What is significant about the scale parameter? What is the analytical solution for the CDF at this point? Add these lines to your CDF plot.

```{r}
age = 0:160
size <- seq(.5,3,.5)
plot(age,pweibull(age,.1,50),type='l',ylim = c(0,1),ylab="density") 
for(i in 1:length(size)){
lines(age,pweibull(age,size[i],50),col=i+1) 
}
legend("bottomright", inset = .05, title = "Shape", legend = c(.1,size), lty = 1, col=1:(length(size)+1))
```

```{r}
fireintervals <- read.table("data/firescar.txt",header=TRUE)
firedata <- rep(fireintervals[,1],fireintervals[,2])
hist(firedata,nclass=max(firedata),xlab="Years",main="Fire Return Interval")
summary(firedata)
```

```{r}
## define Weibull negative log likelihood
wlik <- function(param){
 -sum(dweibull(firedata, param[1], param[2], log = TRUE))
}

rho_mle <- 1/mean(firedata)
param0 <- c(.01,1/rho_mle)
wlik(param0)
fit <- optim(param0,wlik,lower=c(0.01,0.01), upper=c(100,100),method="L-BFGS-B")

```

```{r}
# p1 <- seq(0.01,.6,length=200)
# p2 <- seq(0.01,.99,length=200)
# XY <- expand.grid(X=p1,Y=p1)
# contour(XY$X,XY$Y,Z)
# 
# 
# Z <- mapply(wlik,XY$X,XY$Y)
# 
# require(reshape2)
# require(ggplot2)
# df <- data.frame(XY$X,XY$Y,Z)
# colnames(df)<-c("x","y","z")
# 
# plot <- ggplot(df, aes(x,y,z=z))
# plot + stat_contour(bins=500,aes(colour = ..level..))
# 
# 
# contour(rp*out$par[1],rp*out$par[2],z,levels=c(350,360,370,380)
#     ,xlab="C",ylab="Lambda")
# ## add the  MLE's
# abline(v=out$par[1],lty=2)
# abline(h=out$par[2],lty=2)
# points(1,1/rho_mle,col=2)	

```

------
#### 4) Since the exponential is a special case of the Weibull, use the code from the first case study to solve for the exponential MLE (rho_mle) for the fire scar data


## Case study 3: Binomial/Exponential Mortality

```{r}
surv = c(0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0)
n = length(surv)
y = sum(surv)
t <- 20 
```
 
$$L = Binom(y \vert N, \rho) \propto e^{-\rho T y} \left( 1-e^{-\rho T} \right)^{N-y}$$

```{r}
lbinexp <- function(rho){
  exp(-rho*t*y)*(1-exp(-rho*t)^(n-y))
}

fit <- optimize(lbinexp,lower=.01, upper=.99,maximum=F)
rho_mle_be <- fit$minimum
rseq <- seq(.01,.99,.01)
plot(rseq,lbinexp(rseq),main="Log Likelihood",xlab="rho",ylab="blerg")
lines(rseq,lbinexp(rseq),col=2)
abline(v=rho_mle_be,lty=2)
abline(h=lbinexp(rho_mle_be),lty=2)



```

```{r}
rseq <- seq(.05,.15,.01)
dat <- c(1,9,9,5,27,9,29,1,11,3,3,11,13,6,11,2,4,1,37,10)
rho_mle_e <- 1/mean(dat)
lkexp2 <- function(rho){
  -sum(dexp(dat,rho,log=TRUE))
}
llk2 <- sapply(rseq,lkexp2)
par(mar=c(5,4,4,5)+.1)
plot(rseq,llk2,main="Log Likelihood",xlab="rho",ylab="-log(L)")
lines(rseq,llk2,col=2)
abline(v=rho_mle_e,lty=2)
abline(h=lkexp2(rho_mle_e),lty=2)
par(new=TRUE)
plot(rseq,lbinexp(rseq),xaxt="n",yaxt="n",xlab="",ylab="")
lines(rseq,lbinexp(rseq),col=4)
axis(4)
mtext("-log(L)",side=4,line=3)
legend("topright",col=c("red","blue"),lty=1,legend=c("Case 1","Case 3"))

```

Apply one of the **numerical methods** you used above in order to estimate $\rho$.

## Lab Questions

```
5) Please include the following in your answer:
*  R code
*  Numerical estimate of rho
*  Negative log likelihood profile
*  Answer the following question:  If we wanted to test the assumption that mortality rate was constant in time, which of the two data sets could we use and what model would we fit?


6) Extra Credit: A plot of the exponential PDF with two curves, one based on the Exponential model from the start of this lab and the second from the Binomial/Exponential fit you just found 
```

